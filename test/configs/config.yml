# HPDEX Testing Configuration
# Use: python test.py config.yml

# Test Environment
environment:
  num_workers: 4
  memory_limit_gb: 8.0
  random_seed: 42
  verbose: true
  
# Test Categories (set to false to skip)
test_categories:
  kernel_consistency: true     # Test rank sum kernels vs scipy
  pipeline_consistency: true   # Test DE analysis vs pdex
  performance_kernels: true    # Performance: kernels vs scipy
  performance_pipeline: true   # Performance: DE analysis vs pdex  
  performance_streaming: true  # Performance: streaming vs regular
  edge_cases: true             # Edge cases and robustness
  real_data_benchmarks: true   # Real dataset benchmarks vs pdex
  
# Kernel Consistency Tests
kernel_tests:
  tolerance: 0.0000000001  # 1e-10            # Numerical tolerance for p-value comparison
  test_cases:
    - name: "small_float"
      n_genes: 20
      n_ref: 30
      n_tar: 25
      data_type: "float"
      add_ties: false
      
    - name: "small_int"
      n_genes: 20
      n_ref: 30
      n_tar: 25
      data_type: "int"
      add_ties: true
      
    - name: "medium_float"
      n_genes: 100
      n_ref: 100
      n_tar: 80
      data_type: "float"
      add_ties: false
      
    - name: "medium_int_ties"
      n_genes: 100
      n_ref: 100
      n_tar: 80
      data_type: "int"
      add_ties: true

# Pipeline Consistency Tests (vs pdex)
pipeline_tests:
  correlation_threshold: 0.95  # Minimum correlation for p-values
  fdr_tolerance: 0.05         # FDR comparison tolerance
  pdex_batch_size: 500        # Large batch size for pdex to avoid bottleneck
  test_datasets:
    - name: "small_sc"
      n_cells: 10000
      n_genes: 5000
      n_groups: 4
      differential_fraction: 0.2  # 20% genes are differential
      effect_size: 1.5
      
    - name: "medium_sc"
      n_cells: 10000
      n_genes: 10000
      n_groups: 6
      differential_fraction: 0.15
      effect_size: 1.2
      
    - name: "large_sc"
      n_cells: 100000
      n_genes: 20000
      n_groups: 8
      differential_fraction: 0.1
      effect_size: 1.0

# Performance Tests
performance_tests:
  # Kernel performance vs scipy
  kernel_benchmarks:
    timeout_seconds: 300
    warmup_runs: 2
    benchmark_runs: 5
    test_cases:
      - name: "kernel_small"
        n_genes: 1000
        n_ref: 100
        n_tar: 100
        
      - name: "kernel_medium"
        n_genes: 5000
        n_ref: 500
        n_tar: 400
        
      - name: "kernel_large"
        n_genes: 10000
        n_ref: 1000
        n_tar: 800
  
  # Pipeline performance vs pdex
  pipeline_benchmarks:
    timeout_seconds: 600
    warmup_runs: 1
    benchmark_runs: 3
    test_cases:
      - name: "pipeline_small"
        n_cells: 2000
        n_genes: 1000
        n_groups: 4
        
      - name: "pipeline_medium"
        n_cells: 10000
        n_genes: 5000
        n_groups: 6
        
      - name: "pipeline_large"
        n_cells: 20000
        n_genes: 10000
        n_groups: 8
  
  # Streaming vs regular performance
  streaming_benchmarks:
    timeout_seconds: 900
    memory_limits: [2.0, 4.0, 8.0]  # GB
    test_cases:
      - name: "streaming_medium"
        n_cells: 15000
        n_genes: 8000
        n_groups: 6
        
      - name: "streaming_large"
        n_cells: 50000
        n_genes: 15000
        n_groups: 8
        
      - name: "streaming_huge"
        n_cells: 100000
        n_genes: 20000
        n_groups: 10

# Edge Cases and Robustness
edge_cases:
  test_scenarios:
    - name: "tiny_groups"
      n_cells: 20
      n_genes: 50
      min_group_size: 3
      
    - name: "constant_genes"
      n_cells: 500
      n_genes: 100
      constant_gene_fraction: 0.3
      
    - name: "sparse_data"
      n_cells: 1000
      n_genes: 500
      sparsity: 0.8
      
    - name: "extreme_values"
      n_cells: 500
      n_genes: 100
      include_outliers: true
      outlier_magnitude: 10.0

# Real Data Tests (optional - requires test datasets)
real_data:
  enabled: false  # Set to true if you have real datasets
  data_dir: "./test_data"
  max_cells: 10000  # Subsample if larger
  max_genes: 5000   # Subsample if larger
  
# Output Configuration  
output:
  save_results: true
  results_dir: "./test_results"
  save_plots: true
  detailed_logs: true
  
# Real Data Benchmarks (HPDEX vs pdex on real datasets)
real_data_benchmarks:
  datasets_dir: "./test_data/"  # Directory containing real datasets
  correlation_threshold: 0.95  # Minimum correlation for consistency 
  timeout_seconds: 180         # 3 minutes timeout per dataset
  max_cells: 1000000           # Limit cells for performance testing
  max_genes: 100000            # Limit genes for performance testing
  sample_fraction: 1.0         # Fraction of data to use (1.0 = all)
  
  datasets:
    - name: "hepg2"
      file: "hepg2.h5" 
      groupby_key: "gene"
      reference_group: "non-targeting"
      skip_if_no_groups: true


# Error Handling
error_handling:
  continue_on_error: true  # Continue testing even if some tests fail
  max_retries: 2
  retry_delay: 1.0  # seconds
